{{define "adminCourse"}}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –ö—É—Ä—Å–∞ (Test Mode)</title>
    <meta name="csrf-token" content="test-token-123">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { display: flex; flex-direction: column; min-height: 100vh; background-color: #f3f4f6; }
        main { flex-grow: 1; }
        .content-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 1024px) {
            .content-grid-lg { height: 85vh; }
            .content-grid { grid-template-columns: 280px 1fr 300px; }
        }
        .col-panel { background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); display: flex; flex-direction: column; overflow: hidden; }
        .scrollable-content { overflow-y: auto; flex-grow: 1; padding: 1rem; }
        .content-block { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; background: #fff; position: relative; margin-bottom: 1.5rem; transition: all 0.2s; }
        .content-block:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-color: #6366f1; }
        .block-actions { position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; transition: opacity 0.2s; }
        .content-block:hover .block-actions { opacity: 1; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—Å—Ç–∞–≤–∫–∏ */
        .insert-trigger {
            position: absolute;
            bottom: -14px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            opacity: 0;
            transition: all 0.2s;
        }
        .content-block:hover .insert-trigger { opacity: 1; }
        .insert-trigger:hover { transform: translateX(-50%) scale(1.1); }
    </style>
    <script>
        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            menu.classList.toggle('hidden');
        }
    </script>
</head>
<body>

{{template "adminBarPanel" .}}

<main class="max-w-7xl mx-auto pb-12 px-4 sm:px-6 lg:px-7 pt-[90px]" style="margin-top: 45px">
    <div class="content-grid content-grid-lg flex-grow">

        <div class="order-2 lg:order-1 col-panel flex flex-col h-full">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center sticky top-0 z-10">
                <h2 class="font-semibold text-gray-700">üìö –ú–æ–∏ –ö—É—Ä—Å—ã</h2>
                <button onclick="openCourseModal()" class="text-indigo-600 hover:text-indigo-800 bg-indigo-50 p-1.5 rounded hover:bg-indigo-100 transition shadow-sm">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="courses-list-container" class="scrollable-content space-y-2 relative">
                <div class="text-center text-gray-400 mt-10">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>
        </div>

        <div id="editor-panel" class="order-1 lg:order-2 col-panel relative">
            <div class="p-4 border-b bg-white flex flex-col gap-2 sticky top-0 z-20 shadow-sm">
                <div class="flex justify-between items-start">
                    <div class="w-full mr-4">
                        <label id="editor-label" class="text-xs text-gray-500 font-bold uppercase tracking-wider">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –∏–ª–∏ —É—Ä–æ–∫</label>
                        <input type="text" id="lesson-title-input" disabled value="" class="w-full text-xl font-bold text-gray-800 border-none p-0 focus:ring-0 placeholder-gray-300 bg-transparent" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞...">
                    </div>
                    <div class="flex gap-2">
                        <button id="reset-answers-btn" disabled onclick="resetLessonAnswers()" class="px-3 py-2 bg-rose-100 text-rose-700 hover:bg-rose-200 text-sm font-medium rounded shadow transition flex items-center gap-2 cursor-not-allowed" title="–°–±—Ä–æ—Å–∏—Ç—å –æ—Ç–≤–µ—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —É—Ä–æ–∫–∞">
                            <i class="fas fa-eraser"></i>
                        </button>
                        <button id="save-content-btn" disabled class="px-4 py-2 bg-gray-300 text-white text-sm font-medium rounded shadow transition flex items-center gap-2 cursor-not-allowed">
                            <i class="fas fa-save"></i> <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="content-blocks-area" class="scrollable-content bg-gray-50/50 p-6 pb-20">
                <div class="text-center text-gray-400 mt-20">
                    <i class="fas fa-arrow-left"></i> –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
                </div>
            </div>

            <div class="p-4 border-t bg-gray-50 text-center sticky bottom-0 z-20">
                <button id="add-block-btn" disabled onclick="openTypeModal(null)" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-400 bg-gray-100 cursor-not-allowed transition">
                    <i class="fas fa-plus-circle mr-2"></i> –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫ –≤ –∫–æ–Ω–µ—Ü
                </button>
            </div>
        </div>

        <div class="order-3 lg:order-3 col-panel">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center sticky top-0 z-10">
                <h2 class="font-semibold text-gray-700">üîó –°—Ç—Ä—É–∫—Ç—É—Ä–∞</h2>
                <button id="add-module-btn" disabled title="–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å" class="text-gray-400 bg-gray-100 p-1.5 rounded cursor-not-allowed">
                    <i class="fas fa-folder-plus"></i>
                </button>
            </div>
            <div id="structure-container" class="scrollable-content">
                <div class="text-sm text-gray-400 text-center mt-10">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</div>
            </div>
        </div>
    </div>
</main>

<div id="type-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform transition-all scale-100">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-gray-900">–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫</h3>
            <button onclick="closeTypeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>

        <div class="grid grid-cols-3 gap-4">
            <button onclick="addBlock('text')" class="flex flex-col items-center justify-center p-4 border rounded-xl hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md transition group">
                <i class="fas fa-align-left text-3xl text-gray-400 group-hover:text-indigo-600 mb-2"></i>
                <span class="text-sm font-medium text-gray-700">–¢–µ–∫—Å—Ç</span>
            </button>

            <button onclick="addBlock('code')" class="flex flex-col items-center justify-center p-4 border rounded-xl hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md transition group">
                <i class="fas fa-code text-3xl text-gray-400 group-hover:text-indigo-600 mb-2"></i>
                <span class="text-sm font-medium text-gray-700">–ö–æ–¥</span>
            </button>

            <button onclick="addBlock('video')" class="flex flex-col items-center justify-center p-4 border rounded-xl hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md transition group">
                <i class="fab fa-youtube text-3xl text-gray-400 group-hover:text-red-600 mb-2"></i>
                <span class="text-sm font-medium text-gray-700">YouTube</span>
            </button>

            <button onclick="addBlock('quiz')" class="flex flex-col items-center justify-center p-4 border rounded-xl hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md transition group">
                <i class="fas fa-list-check text-3xl text-gray-400 group-hover:text-indigo-600 mb-2"></i>
                <span class="text-sm font-medium text-gray-700">–¢–µ—Å—Ç</span>
            </button>

            <button onclick="addBlock('vocabulary')" class="flex flex-col items-center justify-center p-4 border rounded-xl hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md transition group">
                <i class="fas fa-language text-3xl text-gray-400 group-hover:text-green-600 mb-2"></i>
                <span class="text-sm font-medium text-gray-700">–°–ª–æ–≤–∞—Ä—å</span>
            </button>

            <button id="btn-add-audio" onclick="addBlock('audio_dictation')" class="flex flex-col items-center justify-center p-4 border rounded-xl hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md transition group disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-headphones text-3xl text-gray-400 group-hover:text-purple-600 mb-2"></i>
                <span class="text-sm font-medium text-gray-700">–ê—É–¥–∏–æ-–¥–∏–∫—Ç–∞–Ω—Ç</span>
            </button>
        </div>
        <div id="audio-warning" class="hidden text-xs text-red-500 text-center mt-2">
            * –î–ª—è —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —è–∑—ã–∫ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫—É—Ä—Å–∞.
        </div>
    </div>
</div>

<div id="course-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 id="modal-course-title" class="text-lg font-bold text-gray-900">–ù–æ–≤—ã–π –ö—É—Ä—Å</h3>
            <button onclick="closeCourseModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <form id="course-form" onsubmit="handleCourseSubmit(event)" class="p-6">
            <input type="hidden" id="course-id">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                <input type="text" id="input-course-title" required class="w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-indigo-500">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">–Ø–∑—ã–∫ –∫—É—Ä—Å–∞ (–¥–ª—è –æ–∑–≤—É—á–∫–∏)</label>
                <select id="input-course-lang" class="w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-indigo-500">
                    <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω --</option>
                    <option value="en-US">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π (US)</option>
                    <option value="en-GB">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π (UK)</option>
                    <option value="ru-RU">–†—É—Å—Å–∫–∏–π</option>
                    <option value="de-DE">–ù–µ–º–µ—Ü–∫–∏–π</option>
                    <option value="fr-FR">–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</option>
                    <option value="es-ES">–ò—Å–ø–∞–Ω—Å–∫–∏–π</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">URL –õ–æ–≥–æ—Ç–∏–ø–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="text" id="input-course-image" class="w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-indigo-500" placeholder="https://...">
            </div>

            <div class="mb-6 flex items-center bg-gray-50 p-3 rounded-md border border-gray-100">
                <input id="input-course-published" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                <label for="input-course-published" class="ml-2 block text-sm text-gray-900">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∫—É—Ä—Å</label>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closeCourseModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm font-medium shadow-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<script>
    let globalCourses = [];
    let currentCourseId = null;
    let currentLessonId = null;
    let insertAfterElement = null;
    let currentCourseLang = ""; // –•—Ä–∞–Ω–∏–º —è–∑—ã–∫ —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Ä—Å–∞

    document.addEventListener('DOMContentLoaded', () => {
        fetchCourses();
    });

    // --- 1. –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–†–û–°–û–í (C CSRF) ---
    async function apiCall(url, method = 'GET', body = null) {
        const headers = {
            'Content-Type': 'application/json'
        };

        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        if (csrfToken) {
            headers['X-CSRF-Token'] = csrfToken;
        }

        const options = { method, headers };
        if (body) {
            options.body = JSON.stringify(body);
        }

        const response = await fetch(url, options);

        if (response.status === 409) {
            const errData = await response.json();
            const error = new Error(errData.error || 'Conflict');
            error.status = 409;
            error.code = errData.error;
            throw error;
        }

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || `–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
        }

        if (response.status === 204) return null;

        return await response.json();
    }

    // --- 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchCourses();
    });

    // --- 3. –ü–û–õ–£–ß–ï–ù–ò–ï –ö–£–†–°–û–í (REAL API) ---
    async function fetchCourses() {
        const container = document.getElementById('courses-list-container');

        try {
            const courses = await apiCall('/api/courses', 'GET');
            globalCourses = courses || [];
            renderCoursesList(globalCourses);

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤:', error);
            container.innerHTML = `
                <div class="text-red-500 text-center text-sm p-4">
                    <i class="fas fa-exclamation-circle mb-1"></i><br>
                    –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å—ã.<br>
                    <span class="text-xs text-gray-400">${error.message}</span>
                </div>
            `;
        }
    }

    // --- 4. –†–ï–ù–î–ï–† –°–ü–ò–°–ö–ê (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    function renderCoursesList(courses) {
        const container = document.getElementById('courses-list-container');
        container.innerHTML = '';

        if (!courses || courses.length === 0) {
            container.innerHTML = `<div class="text-gray-400 text-center text-sm py-4">–ù–µ—Ç –∫—É—Ä—Å–æ–≤.</div>`;
            return;
        }

        courses.forEach(course => {
            const title = course.title || course.Title;
            const isPub = (course.is_published !== undefined) ? course.is_published : course.IsPublished;
            const authorName = course.author?.Name || course.Author?.Name || '–°–∏—Å—Ç–µ–º–∞';
            const cId = course.id || course.ID;

            const statusColor = isPub ? 'bg-indigo-500' : 'bg-gray-300';
            const statusText = isPub ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω' : '–ß–µ—Ä–Ω–æ–≤–∏–∫';

            const item = document.createElement('div');
            item.id = `course-item-${cId}`;
            item.className = "course-item group flex items-center justify-between p-2 rounded-md hover:bg-indigo-50 cursor-pointer border border-transparent hover:border-indigo-100 transition animate-fade-in mb-1";
            item.setAttribute('onclick', `selectCourse(${cId})`);

            item.innerHTML = `
                <div class="flex items-center truncate flex-grow">
                    <div class="w-1.5 h-10 ${statusColor} rounded-l mr-3"></div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-bold text-gray-800 truncate">${title} ${cId}</p>
                        <div class="flex items-center text-xs text-gray-500 mt-0.5 gap-2">
                            <span><i class="fas fa-user-circle"></i> ${authorName}</span>
                            <span class="text-gray-300">|</span>
                            <span>${statusText}</span>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity ml-2">
                    <button onclick="openEditCourseModal(event, ${cId})" class="w-7 h-7 rounded-full hover:bg-white text-gray-400 hover:text-blue-600 flex items-center justify-center"><i class="fas fa-pen text-xs"></i></button>
                    <button onclick="deleteCourse(event, ${cId})" class="w-7 h-7 rounded-full hover:bg-white text-gray-400 hover:text-red-600 flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                </div>
            `;
            container.appendChild(item);
        });

        if (currentCourseId) {
            const active = document.getElementById(`course-item-${currentCourseId}`);
            if(active) active.classList.add('bg-indigo-100', 'border-indigo-200');
        }
    }

    // --- –í–´–ë–û–† –ö–£–†–°–ê ---
    async function selectCourse(id) {
        if (currentCourseId === id) return;
        currentCourseId = id;

        // –ù–∞—Ö–æ–¥–∏–º –∫—É—Ä—Å –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —Å–ø–∏—Å–∫–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –µ–≥–æ —è–∑—ã–∫
        const course = globalCourses.find(c => c.id === id);
        if (course) {
            currentCourseLang = course.language || "";
        } else {
            currentCourseLang = "";
        }

        document.querySelectorAll('[id^="course-item-"]').forEach(el => el.classList.remove('bg-indigo-100'));
        document.getElementById(`course-item-${id}`)?.classList.add('bg-indigo-100');

        const addModBtn = document.getElementById('add-module-btn');
        addModBtn.disabled = false;
        addModBtn.className = "text-indigo-600 hover:text-indigo-800 bg-indigo-50 p-1.5 rounded hover:bg-indigo-100 transition cursor-pointer";
        addModBtn.onclick = () => createModule();

        document.getElementById('lesson-title-input').value = "";
        document.getElementById('lesson-title-input').disabled = true;
        document.getElementById('content-blocks-area').innerHTML = `<div class="text-center text-gray-400 mt-20">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫ —Å–ø—Ä–∞–≤–∞</div>`;
        document.getElementById('reset-answers-btn').disabled = true;
        document.getElementById('reset-answers-btn').classList.add('cursor-not-allowed');

        const structContainer = document.getElementById('structure-container');
        structContainer.innerHTML = '<div class="text-center text-gray-400 mt-5"><i class="fas fa-spinner fa-spin"></i></div>';

        try {
            const courseData = await apiCall(`/api/courses/${id}`);
            renderModules(courseData.modules || []);
        } catch (e) {
            console.error(e);
            structContainer.innerHTML = '<div class="text-red-500 text-center text-xs">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        }
    }

    // --- MODULES & LESSONS RENDER ---
    function renderModules(modules) {
        const container = document.getElementById('structure-container');
        container.innerHTML = '';

        if (!modules || modules.length === 0) {
            container.innerHTML = `<div class="text-center text-sm text-gray-400 mt-4">–ú–æ–¥—É–ª–µ–π –Ω–µ—Ç.<br>–ù–∞–∂–º–∏—Ç–µ "+" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è.</div>`;
            return;
        }

        modules.forEach(mod => {
            const modId = mod.id || mod.ID;
            const modTitle = mod.title || mod.Title;
            const lessons = mod.lessons || [];

            const modDiv = document.createElement('div');
            modDiv.className = "mb-4 bg-white border rounded-lg overflow-hidden animate-fade-in";

            let lessonsHtml = '';
            if (lessons.length > 0) {
                lessonsHtml = `<ul class="text-sm">` + lessons.map(l => {
                    const lId = l.id || l.ID;
                    const lTitle = l.title || l.Title;
                    return `
                    <li onclick="loadLesson(${lId}, '${lTitle}')" class="p-2 pl-4 border-l-4 border-transparent hover:border-indigo-400 hover:bg-gray-50 flex justify-between items-center cursor-pointer group transition">
                        <span class="text-gray-600 group-hover:text-gray-900 truncate">${lTitle}</span>
                        <div class="hidden group-hover:flex space-x-2">
                             <i onclick="event.stopPropagation(); deleteLesson(${lId})" class="fas fa-trash text-xs text-gray-300 hover:text-red-500" title="–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–∫"></i>
                        </div>
                    </li>`;
                }).join('') + `</ul>`;
            } else {
                lessonsHtml = `<div class="p-2 text-xs text-gray-400 italic pl-4">–ù–µ—Ç —É—Ä–æ–∫–æ–≤</div>`;
            }

            modDiv.innerHTML = `
                <div class="bg-gray-100 p-2 flex justify-between items-center border-b group">
                    <h3 class="font-medium text-sm text-gray-800 pl-1 truncate w-full cursor-pointer"
                        onclick="editModule(${modId}, '${modTitle}')" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">${modTitle}</h3>
                    <div class="flex space-x-1 opacity-60 group-hover:opacity-100 transition">
                        <button onclick="createLesson(${modId})" class="text-green-600 hover:bg-green-100 p-1 rounded" title="–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫"><i class="fas fa-plus-square"></i></button>
                        <button onclick="deleteModule(${modId})" class="text-red-600 hover:bg-red-100 p-1 rounded" title="–£–¥–∞–ª–∏—Ç—å –º–æ–¥—É–ª—å"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                ${lessonsHtml}
            `;
            container.appendChild(modDiv);
        });
    }
    async function createModule() {
        if (!currentCourseId) return;
        const title = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è:");
        if (!title) return;

        try {
            await apiCall('/api/modules', 'POST', { course_id: currentCourseId, title: title });
            refreshStructure();
        } catch (e) { alert(e.message); }
    }

    async function editModule(id, oldTitle) {
        const newTitle = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è:", oldTitle);
        if (!newTitle || newTitle === oldTitle) return;

        try {
            await apiCall(`/api/modules/${id}`, 'PUT', { title: newTitle });
            refreshStructure();
        } catch (e) { alert(e.message); }
    }

    async function deleteModule(id) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –º–æ–¥—É–ª—å –∏ –í–°–ï –µ–≥–æ —É—Ä–æ–∫–∏?")) return;
        try {
            await apiCall(`/api/modules/${id}`, 'DELETE');
            refreshStructure();
        } catch (e) { alert(e.message); }
    }

    async function createLesson(moduleId) {
        const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞:");
        if (!title) return;

        try {
            await apiCall('/api/lessons', 'POST', { module_id: moduleId, title: title });
            refreshStructure();
        } catch (e) { alert(e.message); }
    }

    async function deleteLesson(id) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–∫?")) return;
        try {
            await apiCall(`/api/lessons/${id}`, 'DELETE');
            refreshStructure();
        } catch (e) { alert(e.message); }
    }

    async function refreshStructure() {
        if(!currentCourseId) return;
        const tempId = currentCourseId;
        currentCourseId = null;
        await selectCourse(tempId);
    }

    // --- EDITOR LOGIC (LOAD LESSON) ---
    async function loadLesson(lessonId, title) {
        currentLessonId = lessonId;
        insertAfterElement = null;

        const area = document.getElementById('content-blocks-area');
        const titleInput = document.getElementById('lesson-title-input');
        const saveBtn = document.getElementById('save-content-btn');
        const addBtn = document.getElementById('add-block-btn');
        const resetBtn = document.getElementById('reset-answers-btn');

        area.innerHTML = '<div class="flex flex-col items-center justify-center h-64 text-gray-400 animate-pulse"><i class="fas fa-layer-group text-4xl mb-4"></i><p>–ó–∞–≥—Ä—É–∑–∫–∞ –±–ª–æ–∫–æ–≤...</p></div>';

        titleInput.value = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        titleInput.disabled = true;
        saveBtn.disabled = true;
        addBtn.disabled = true;
        resetBtn.disabled = true;
        resetBtn.classList.add('cursor-not-allowed');

        try {
            const lesson = await apiCall(`/api/lessons/${lessonId}`, 'GET');

            titleInput.value = lesson.title;
            titleInput.disabled = false;

            saveBtn.onclick = () => saveLessonContent(lessonId);

            area.innerHTML = '';

            const blocks = lesson.content_blocks || [];

            if (blocks.length > 0) {
                blocks.forEach(block => {
                    addBlock(block.type, block.data, block.id);
                });
            } else {
                area.innerHTML = `<div class="text-center py-10 text-gray-300 border-2 border-dashed border-gray-200 rounded-lg">–£—Ä–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç.</div>`;
            }

            saveBtn.disabled = false;
            saveBtn.className = "px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded shadow transition flex items-center gap-2";

            addBtn.disabled = false;
            addBtn.className = "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition cursor-pointer";

            resetBtn.disabled = false;
            resetBtn.classList.remove('cursor-not-allowed');

        } catch (e) {
            console.error(e);
            area.innerHTML = `<div class="text-red-500 p-4 bg-red-50 rounded border border-red-100">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</div>`;
        }
    }

    // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –£–†–û–ö–ê (UPDATE) ---
    async function saveLessonContent(id, forceReset = false) {
        const titleInput = document.getElementById('lesson-title-input');
        const container = document.getElementById('content-blocks-area');
        const saveBtn = document.getElementById('save-content-btn');

        const originalBtnHtml = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        saveBtn.disabled = true;
        container.classList.add('opacity-70', 'pointer-events-none');

        try {
            const blocks = [];
            const blockElements = container.querySelectorAll('.content-block');

            blockElements.forEach(el => {
                const type = el.dataset.type;
                const dbId = parseInt(el.dataset.dbId) || 0;
                let blockData = {};

                if (type === 'text' || type === 'code' || type === 'video') {
                    const contentEl = el.querySelector('.block-content');
                    if (contentEl) {
                        blockData.content = contentEl.value;
                    }
                }
                else if (type === 'quiz') {
                    const questionEl = el.querySelector('.quiz-question');
                    blockData.question = questionEl ? questionEl.value : '';
                    blockData.options = [];
                    blockData.correct_index = 0;

                    const optionRows = el.querySelectorAll('.option-row');
                    optionRows.forEach((row, idx) => {
                        const textInput = row.querySelector('.quiz-option-text');
                        const radioInput = row.querySelector('.quiz-correct-radio');
                        if (textInput) {
                            blockData.options.push(textInput.value);
                            if (radioInput && radioInput.checked) {
                                blockData.correct_index = idx;
                            }
                        }
                    });
                }
                else if (type === 'vocabulary') {
                    const titleEl = el.querySelector('.vocab-title');
                    blockData.title = titleEl ? titleEl.value : '';
                    blockData.words = [];

                    const wordRows = el.querySelectorAll('.vocab-row');
                    wordRows.forEach(row => {
                        const term = row.querySelector('.vocab-term').value;
                        const trans = row.querySelector('.vocab-trans').value;
                        const transl = row.querySelector('.vocab-transl').value;

                        if (term.trim() !== '') {
                            blockData.words.push({
                                term: term,
                                transcription: trans,
                                translation: transl
                            });
                        }
                    });
                }
                // === –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø –ê–£–î–ò–û-–î–ò–ö–¢–ê–ù–¢–ê ===
                else if (type === 'audio_dictation') {
                    const textEl = el.querySelector('.audio-text');
                    blockData.text = textEl ? textEl.value : '';
                }

                blocks.push({
                    id: dbId,
                    type: type,
                    data: blockData
                });
            });

            await apiCall(`/api/lessons/${id}`, 'PUT', { title: titleInput.value });

            const payload = {
                blocks: blocks,
                force_reset: forceReset
            };

            await apiCall(`/api/lessons/${id}/content`, 'PUT', payload);

            saveBtn.innerHTML = '<i class="fas fa-check"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
            saveBtn.className = "px-4 py-2 bg-green-600 text-white text-sm font-medium rounded shadow transition flex items-center gap-2";

            updateSidebarTitle(id, titleInput.value);

            setTimeout(() => {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                saveBtn.className = "px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded shadow transition flex items-center gap-2";
                saveBtn.disabled = false;
            }, 1500);

            loadLesson(id, titleInput.value);

        } catch (e) {
            console.error(e);

            if (e.status === 409 && e.code === "BLOCK_HAS_ANSWERS") {
                const confirmed = confirm("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–í—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –±–ª–æ–∫–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç—É–¥–µ–Ω—Ç—ã —É–∂–µ –¥–∞–ª–∏ –æ—Ç–≤–µ—Ç—ã.\n\n–ï—Å–ª–∏ –≤—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ, –ø—Ä–æ–≥—Ä–µ—Å—Å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ —ç—Ç–∏–º –≤–æ–ø—Ä–æ—Å–∞–º –±—É–¥–µ—Ç –°–ë–†–û–®–ï–ù (—É–¥–∞–ª–µ–Ω).\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?");
                if (confirmed) {
                    container.classList.remove('opacity-70', 'pointer-events-none');
                    saveBtn.disabled = false;
                    await saveLessonContent(id, true);
                    return;
                } else {
                    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞.");
                    loadLesson(id, titleInput.value);
                }
            } else {
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message);
            }

            saveBtn.innerHTML = originalBtnHtml;
            saveBtn.disabled = false;
        } finally {
            container.classList.remove('opacity-70', 'pointer-events-none');
        }
    }

    async function resetLessonAnswers() {
        if (!currentLessonId) return;
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –í–°–ï –æ—Ç–≤–µ—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —É—Ä–æ–∫–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.")) return;
        await saveLessonContent(currentLessonId, true);
    }

    function updateSidebarTitle(id, newTitle) {
        const listItem = document.querySelector(`li[onclick*="loadLesson(${id},"]`);
        if (listItem) {
            const textSpan = listItem.querySelector('span');
            if (textSpan) textSpan.textContent = newTitle;
            listItem.setAttribute('onclick', `loadLesson(${id}, '${newTitle.replace(/'/g, "\\'")}')`);
        }
    }


    // --- –í–´–ë–û–† –£–†–û–ö–ê ---


    // --- –ú–û–î–ê–õ–ö–ò (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏) ---
    function openCourseModal() {
        document.getElementById('course-form').reset();
        document.getElementById('course-id').value = '';
        document.getElementById('modal-course-title').textContent = '–°–æ–∑–¥–∞—Ç—å –ù–æ–≤—ã–π –ö—É—Ä—Å';
        document.getElementById('course-modal').classList.remove('hidden');
    }
    function openEditCourseModal(event, id) {
        event.stopPropagation();
        const course = globalCourses.find(c => c.id === id);
        if (!course) return;
        document.getElementById('course-id').value = course.id;
        document.getElementById('input-course-title').value = course.title;
        document.getElementById('input-course-published').checked = course.is_published;
        document.getElementById('input-course-lang').value = course.language || ""; // <--- NEW
        document.getElementById('input-course-image').value = course.image_url || ""; // <--- NEW
        document.getElementById('modal-course-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—Å';
        document.getElementById('course-modal').classList.remove('hidden');
    }
    function closeCourseModal() { document.getElementById('course-modal').classList.add('hidden'); }
    async function handleCourseSubmit(event) {
        event.preventDefault();
        const courseId = document.getElementById('course-id').value;
        const title = document.getElementById('input-course-title').value;
        const isPublished = document.getElementById('input-course-published').checked;
        const language = document.getElementById('input-course-lang').value; // <--- NEW
        const imageUrl = document.getElementById('input-course-image').value; // <--- NEW

        const payload = {
            title: title,
            is_published: isPublished,
            language: language, // <--- NEW
            image_url: imageUrl // <--- NEW
        };

        try {
            let url = '/api/courses';
            let method = 'POST';

            if (courseId) {
                url = `/api/courses/${courseId}`;
                method = 'PUT';
            }

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞');
            }

            const result = await response.json();
            closeCourseModal();
            if (typeof fetchCourses === 'function') {
                fetchCourses();
            } else {
                window.location.reload();
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—É—Ä—Å');
        }
    }
    async function deleteCourse(event, id) {
        event.stopPropagation();
        if (!confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫—É—Ä—Å —Å ID: ${id}?`)) {
            return;
        }
        try {
            const response = await fetch(`/api/courses/${id}`, {
                method: 'DELETE',
            });
            if (response.ok) {
                alert('‚úÖ –ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                window.location.reload();
            } else {
                const errorText = await response.text();
                alert(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${response.status} - ${errorText || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            }
        } catch (error) {
            console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
            alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.');
        }
    }

    // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –ë–õ–û–ö–û–í ---
    const typeModal = document.getElementById('type-modal');

    function openTypeModal(triggerBtn = null) {
        if (triggerBtn) {
            insertAfterElement = triggerBtn.closest('.content-block');
        } else {
            insertAfterElement = null;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —è–∑—ã–∫–∞ –¥–ª—è –∞—É–¥–∏–æ-–¥–∏–∫—Ç–∞–Ω—Ç–∞
        const audioBtn = document.getElementById('btn-add-audio');
        const audioWarning = document.getElementById('audio-warning');
        if (currentCourseLang) {
            audioBtn.disabled = false;
            audioWarning.classList.add('hidden');
        } else {
            audioBtn.disabled = true;
            audioWarning.classList.remove('hidden');
        }

        typeModal.classList.remove('hidden');
    }

    function closeTypeModal() { typeModal.classList.add('hidden'); }
    typeModal.addEventListener('click', (e) => { if (e.target === typeModal) closeTypeModal(); });

    function addBlock(type, data = null, dbId = 0) {
        const container = document.getElementById('content-blocks-area');
        const hasBlocks = container.querySelector('.content-block');
        if (!hasBlocks) container.innerHTML = '';

        const uniqueId = Date.now() + Math.random().toString(36).substr(2, 9);

        let innerHTML = '';
        let icon = '';
        let label = '';
        const valContent = data ? data.content || '' : '';

        if (type === 'text') {
            icon = 'fa-align-left'; label = '–¢–µ–∫—Å—Ç';
            innerHTML = `<textarea class="block-content w-full border border-gray-300 p-3 rounded text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none transition resize-y" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç...">${valContent}</textarea>`;
        } else if (type === 'code') {
            icon = 'fa-code'; label = '–ö–æ–¥';
            innerHTML = `<textarea class="block-content w-full bg-[#1e1e1e] text-[#d4d4d4] p-3 rounded text-sm font-mono focus:ring-2 focus:ring-indigo-500 focus:outline-none transition" rows="4" placeholder="// Code...">${valContent}</textarea>`;
        } else if (type === 'video') {
            icon = 'fa-video'; label = 'YouTube';
            innerHTML = `<div class="flex items-center gap-2 border border-gray-300 p-2 rounded bg-white"><i class="fab fa-youtube text-red-500 text-lg"></i><input type="text" class="block-content w-full text-sm focus:outline-none" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ" value="${valContent}"></div>`;

        } else if (type === 'quiz') {
            icon = 'fa-list-check'; label = '–¢–µ—Å—Ç (—Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏)';
            const question = data ? data.question || '' : '';
            innerHTML = `
                <div class="quiz-container">
                    <input type="text" class="quiz-question w-full border-b-2 border-indigo-100 p-2 text-sm font-bold mb-3 focus:border-indigo-500 focus:outline-none" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å..." value="${question}">
                    <div class="quiz-options pl-2 border-l-2 border-gray-100 space-y-2"></div>
                    <button type="button" onclick="addQuizOption(this)" class="mt-2 text-xs text-indigo-600 hover:text-indigo-800 font-medium flex items-center gap-1">
                        <i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç
                    </button>
                </div>
            `;
        }
        else if (type === 'vocabulary') {
            icon = 'fa-language'; label = '–°–ª–æ–≤–∞—Ä—å (–ù–æ–≤—ã–µ —Å–ª–æ–≤–∞)';
            const title = data ? data.title || '' : '';
            innerHTML = `
                <div class="vocab-container">
                    <input type="text" class="vocab-title w-full border-b-2 border-green-100 p-2 text-sm font-bold mb-3 focus:border-green-500 focus:outline-none" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ø–∏—Å–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–°–ª–æ–≤–∞ –∫ —É—Ä–æ–∫—É')" value="${title}">
                    <div class="vocab-list space-y-2"></div>
                    <button type="button" onclick="addVocabularyItem(this)" class="mt-3 text-xs text-green-600 hover:text-green-800 font-medium flex items-center gap-1">
                        <i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ
                    </button>
                </div>
            `;
        }
        // === –ù–û–í–´–ô –¢–ò–ü: –ê–£–î–ò–û-–î–ò–ö–¢–ê–ù–¢ ===
        else if (type === 'audio_dictation') {
            icon = 'fa-headphones'; label = '–ê—É–¥–∏–æ-–¥–∏–∫—Ç–∞–Ω—Ç';
            const text = data ? data.text || '' : '';
            innerHTML = `
                <div class="audio-container">
                    <p class="text-xs text-gray-500 mb-2">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–æ–±–æ—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–æ—á–∏—Ç–∞—Ç—å. –°—Ç—É–¥–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—É–¥–µ—Ç –Ω–∞–ø–∏—Å–∞—Ç—å –µ–≥–æ –Ω–∞ —Å–ª—É—Ö.</p>
                    <textarea class="audio-text w-full border border-purple-200 bg-purple-50 p-3 rounded text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none transition resize-y" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –¥–∏–∫—Ç–∞–Ω—Ç–∞...">${text}</textarea>
                    <div class="mt-2 text-xs text-purple-600 flex items-center gap-1">
                        <i class="fas fa-info-circle"></i> –Ø–∑—ã–∫ –æ–∑–≤—É—á–∫–∏: <b>${currentCourseLang}</b>
                    </div>
                </div>
            `;
        }

        const div = document.createElement('div');
        div.className = "content-block relative group bg-white border border-gray-200 rounded-lg p-1 mb-4 shadow-sm hover:shadow-md transition-all duration-200";
        div.dataset.type = type;
        div.dataset.blockId = uniqueId;
        div.dataset.dbId = dbId;

        const toolbar = `
            <div class="flex justify-between items-center bg-gray-50 p-2 rounded-t-lg border-b border-gray-100 mb-2 handle cursor-move select-none">
                <div class="flex items-center gap-2 text-gray-500 text-xs font-bold uppercase tracking-wider"><i class="fas ${icon}"></i> ${label} <span class="text-[10px] text-gray-300 ml-2">ID: ${dbId || 'New'}</span></div>
                <div class="flex items-center gap-1">
                    <button onclick="moveBlock(this, -1)" class="w-6 h-6 text-gray-400 hover:text-indigo-600"><i class="fas fa-arrow-up"></i></button>
                    <button onclick="moveBlock(this, 1)" class="w-6 h-6 text-gray-400 hover:text-indigo-600"><i class="fas fa-arrow-down"></i></button>
                    <div class="w-px h-4 bg-gray-300 mx-1"></div>
                    <button onclick="removeBlock(this)" class="w-6 h-6 text-gray-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;

        const insertBtn = `
            <button onclick="openTypeModal(this)" class="insert-trigger w-8 h-8 rounded-full bg-indigo-600 text-white shadow-lg flex items-center justify-center hover:bg-indigo-700 transition" title="–í—Å—Ç–∞–≤–∏—Ç—å –±–ª–æ–∫ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ">
                <i class="fas fa-plus text-xs"></i>
            </button>
        `;

        div.innerHTML = toolbar + `<div class="p-2">${innerHTML}</div>` + insertBtn;

        if (insertAfterElement) {
            container.insertBefore(div, insertAfterElement.nextElementSibling);
        } else {
            container.appendChild(div);
        }

        if (type === 'quiz') {
            const addBtn = div.querySelector('button[onclick="addQuizOption(this)"]');
            const options = data ? data.options || ['', ''] : ['', ''];
            const correctIndex = data ? data.correct_index : 0;
            options.forEach((optText, index) => {
                const isCorrect = (index === parseInt(correctIndex));
                addQuizOption(addBtn, optText, isCorrect);
            });
        }
        else if (type === 'vocabulary') {
            const addBtn = div.querySelector('button[onclick="addVocabularyItem(this)"]');
            const words = data ? data.words || [] : [{term:'', transcription:'', translation:''}];
            words.forEach(w => {
                addVocabularyItem(addBtn, w.term, w.transcription, w.translation);
            });
        }

        if (!data) {
            div.scrollIntoView({ behavior: 'smooth', block: 'center' });
            if(typeof closeTypeModal === 'function') closeTypeModal();
        }
    }

    function moveBlock(btn, direction) {
        const currentBlock = btn.closest('.content-block');
        const container = document.getElementById('content-blocks-area');
        if (direction === -1) {
            const prevBlock = currentBlock.previousElementSibling;
            if (prevBlock) container.insertBefore(currentBlock, prevBlock);
        } else if (direction === 1) {
            const nextBlock = currentBlock.nextElementSibling;
            if (nextBlock) container.insertBefore(nextBlock, currentBlock);
        }
    }

    function removeBlock(btn) {
        if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫?")) return;
        const block = btn.closest('.content-block');
        const container = document.getElementById('content-blocks-area');
        block.style.opacity = '0';
        block.style.transform = 'scale(0.95)';
        setTimeout(() => {
            block.remove();
            const remainingBlocks = container.querySelectorAll('.content-block');
            if (remainingBlocks.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-gray-300 border-2 border-dashed border-gray-200 rounded-lg">–£—Ä–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç.</div>`;
            }
        }, 200);
    }

    function addQuizOption(btn, value = '', isCorrect = false) {
        const optionsContainer = btn.closest('.quiz-container').querySelector('.quiz-options');
        const blockId = btn.closest('.content-block').dataset.blockId;
        const div = document.createElement('div');
        div.className = "flex items-center gap-2 mb-2 option-row";
        div.innerHTML = `
            <input type="radio" name="quiz_radio_${blockId}" class="quiz-correct-radio w-4 h-4 text-indigo-600 focus:ring-indigo-500 border-gray-300" ${isCorrect ? 'checked' : ''} title="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π">
            <input type="text" class="quiz-option-text flex-1 border border-gray-300 p-2 rounded text-sm focus:outline-none focus:border-indigo-500 transition" placeholder="–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞" value="${value}">
            <button type="button" onclick="this.closest('.option-row').remove()" class="text-gray-400 hover:text-red-500 p-1" title="–£–¥–∞–ª–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç"><i class="fas fa-times"></i></button>
        `;
        optionsContainer.appendChild(div);
    }

    function addVocabularyItem(btn, term = '', trans = '', transl = '') {
        const listContainer = btn.closest('.vocab-container').querySelector('.vocab-list');
        const div = document.createElement('div');
        div.className = "vocab-row grid grid-cols-12 gap-2 items-center bg-gray-50 p-2 rounded border border-gray-100";

        div.innerHTML = `
            <div class="col-span-4">
                <input type="text" class="vocab-term w-full border border-gray-300 p-1.5 rounded text-sm focus:outline-none focus:border-green-500" placeholder="–°–ª–æ–≤–æ" value="${term}">
            </div>
            <div class="col-span-3">
                <input type="text" class="vocab-trans w-full border border-gray-300 p-1.5 rounded text-sm focus:outline-none focus:border-green-500 font-mono text-gray-600" placeholder="[–¢—Ä–∞–Ω—Å–∫—Ä.]" value="${trans}">
            </div>
            <div class="col-span-4">
                <input type="text" class="vocab-transl w-full border border-gray-300 p-1.5 rounded text-sm focus:outline-none focus:border-green-500" placeholder="–ü–µ—Ä–µ–≤–æ–¥" value="${transl}">
            </div>
            <div class="col-span-1 text-center">
                <button type="button" onclick="this.closest('.vocab-row').remove()" class="text-gray-400 hover:text-red-500 p-1"><i class="fas fa-times"></i></button>
            </div>
        `;
        listContainer.appendChild(div);
    }
</script>
</body>
</html>
{{end}}