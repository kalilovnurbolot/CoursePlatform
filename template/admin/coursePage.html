{{define "adminCourse"}}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –ö—É—Ä—Å–∞ (Test Mode)</title>
    <meta name="csrf-token" content="test-token-123">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { display: flex; flex-direction: column; min-height: 100vh; background-color: #f3f4f6; }
        main { flex-grow: 1; }
        .content-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 1024px) {
            .content-grid-lg { height: 85vh; }
            .content-grid { grid-template-columns: 280px 1fr 300px; }
        }
        .col-panel { background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); display: flex; flex-direction: column; overflow: hidden; }
        .scrollable-content { overflow-y: auto; flex-grow: 1; padding: 1rem; }
        .content-block { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; background: #fff; position: relative; margin-bottom: 1rem; transition: all 0.2s; }
        .content-block:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-color: #6366f1; }
        .block-actions { position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; transition: opacity 0.2s; }
        .content-block:hover .block-actions { opacity: 1; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <script>
        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            menu.classList.toggle('hidden');
        }
    </script>
</head>
<body>

{{template "adminBarPanel" .}}

<main class="max-w-7xl mx-auto pb-12 px-4 sm:px-6 lg:px-7 pt-[90px]" style="margin-top: 45px">
    <div class="content-grid content-grid-lg flex-grow">

        <div class="order-2 lg:order-1 col-panel flex flex-col h-full">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center sticky top-0 z-10">
                <h2 class="font-semibold text-gray-700">üìö –ú–æ–∏ –ö—É—Ä—Å—ã</h2>
                <button onclick="openCourseModal()" class="text-indigo-600 hover:text-indigo-800 bg-indigo-50 p-1.5 rounded hover:bg-indigo-100 transition shadow-sm">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="courses-list-container" class="scrollable-content space-y-2 relative">
                <div class="text-center text-gray-400 mt-10">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>
        </div>

        <div id="editor-panel" class="order-1 lg:order-2 col-panel relative">
            <div class="p-4 border-b bg-white flex flex-col gap-2 sticky top-0 z-20 shadow-sm">
                <div class="flex justify-between items-start">
                    <div class="w-full mr-4">
                        <label id="editor-label" class="text-xs text-gray-500 font-bold uppercase tracking-wider">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –∏–ª–∏ —É—Ä–æ–∫</label>
                        <input type="text" id="lesson-title-input" disabled value="" class="w-full text-xl font-bold text-gray-800 border-none p-0 focus:ring-0 placeholder-gray-300 bg-transparent" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞...">
                    </div>
                    <button id="save-content-btn" disabled class="px-4 py-2 bg-gray-300 text-white text-sm font-medium rounded shadow transition flex items-center gap-2 cursor-not-allowed">
                        <i class="fas fa-save"></i> <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                    </button>
                </div>
            </div>

            <div id="content-blocks-area" class="scrollable-content bg-gray-50/50 p-6">
                <div class="text-center text-gray-400 mt-20">
                    <i class="fas fa-arrow-left"></i> –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
                </div>
            </div>

            <div class="p-4 border-t bg-gray-50 text-center">
                <button id="add-block-btn" disabled onclick="openTypeModal()" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-400 bg-gray-100 cursor-not-allowed transition">
                    <i class="fas fa-plus-circle mr-2"></i> –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                </button>
            </div>
        </div>

        <div class="order-3 lg:order-3 col-panel">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center sticky top-0 z-10">
                <h2 class="font-semibold text-gray-700">üîó –°—Ç—Ä—É–∫—Ç—É—Ä–∞</h2>
                <button id="add-module-btn" disabled title="–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å" class="text-gray-400 bg-gray-100 p-1.5 rounded cursor-not-allowed">
                    <i class="fas fa-folder-plus"></i>
                </button>
            </div>
            <div id="structure-container" class="scrollable-content">
                <div class="text-sm text-gray-400 text-center mt-10">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</div>
            </div>
        </div>
    </div>
</main>

<div id="type-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform transition-all scale-100">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-gray-900">–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫</h3>
            <button onclick="closeTypeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <button onclick="addBlock('text')" class="flex flex-col items-center justify-center p-4 border rounded-xl hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md transition group">
                <i class="fas fa-align-left text-3xl text-gray-400 group-hover:text-indigo-600 mb-2"></i>
                <span class="text-sm font-medium text-gray-700">–¢–µ–∫—Å—Ç</span>
            </button>

            <button onclick="addBlock('code')" class="flex flex-col items-center justify-center p-4 border rounded-xl hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md transition group">
                <i class="fas fa-code text-3xl text-gray-400 group-hover:text-indigo-600 mb-2"></i>
                <span class="text-sm font-medium text-gray-700">–ö–æ–¥</span>
            </button>

            <button onclick="addBlock('quiz')" class="flex flex-col items-center justify-center p-4 border rounded-xl hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md transition group">
                <i class="fas fa-list-check text-3xl text-gray-400 group-hover:text-indigo-600 mb-2"></i>
                <span class="text-sm font-medium text-gray-700">–¢–µ—Å—Ç</span>
            </button>

            <button onclick="addBlock('video')" class="flex flex-col items-center justify-center p-4 border rounded-xl hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md transition group">
                <i class="fab fa-youtube text-3xl text-gray-400 group-hover:text-red-600 mb-2"></i>
                <span class="text-sm font-medium text-gray-700">YouTube</span>
            </button>
        </div>
    </div>
</div>

<div id="course-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 id="modal-course-title" class="text-lg font-bold text-gray-900">–ù–æ–≤—ã–π –ö—É—Ä—Å</h3>
            <button onclick="closeCourseModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <form id="course-form" onsubmit="handleCourseSubmit(event)" class="p-6">
            <input type="hidden" id="course-id">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞ 1</label>
                <input type="text" id="input-course-title" required class="w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-indigo-500">
            </div>
            <div class="mb-6 flex items-center bg-gray-50 p-3 rounded-md border border-gray-100">
                <input id="input-course-published" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                <label for="input-course-published" class="ml-2 block text-sm text-gray-900">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∫—É—Ä—Å</label>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closeCourseModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm font-medium shadow-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<script>
    let globalCourses = [];
    let currentCourseId = null;

    document.addEventListener('DOMContentLoaded', () => {
        fetchCourses();
    });

    // --- 1. –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–†–û–°–û–í (C CSRF) ---
    async function apiCall(url, method = 'GET', body = null) {
        const headers = {
            'Content-Type': 'application/json'
        };

        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ CSRF —Ç–æ–∫–µ–Ω –≤ meta-—Ç–µ–≥–µ (–µ—Å–ª–∏ –≤—ã –µ–≥–æ –¥–æ–±–∞–≤–∏–ª–∏ –≤ HTML)
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        if (csrfToken) {
            headers['X-CSRF-Token'] = csrfToken; // –ò–ª–∏ 'X-CSRF-Param', –∑–∞–≤–∏—Å–∏—Ç –æ—Ç middleware
        }

        const options = { method, headers };
        if (body) {
            options.body = JSON.stringify(body);
        }

        const response = await fetch(url, options);

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || `–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
        }

        // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä 204 No Content), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null
        if (response.status === 204) return null;

        return await response.json();
    }

    // --- 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchCourses();
    });

    // --- 3. –ü–û–õ–£–ß–ï–ù–ò–ï –ö–£–†–°–û–í (REAL API) ---
    async function fetchCourses() {
        const container = document.getElementById('courses-list-container');

        try {
            // –î–µ–ª–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ /api/courses
            const courses = await apiCall('/api/courses', 'GET');

            // –ï—Å–ª–∏ –ø—Ä–∏—à–µ–ª null –∏–ª–∏ undefined, —Å—Ç–∞–≤–∏–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
            globalCourses = courses || [];

            renderCoursesList(globalCourses);

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤:', error);
            container.innerHTML = `
                <div class="text-red-500 text-center text-sm p-4">
                    <i class="fas fa-exclamation-circle mb-1"></i><br>
                    –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å—ã.<br>
                    <span class="text-xs text-gray-400">${error.message}</span>
                </div>
            `;
        }
    }

    // --- 4. –†–ï–ù–î–ï–† –°–ü–ò–°–ö–ê (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    function renderCoursesList(courses) {
        const container = document.getElementById('courses-list-container');
        container.innerHTML = '';

        if (!courses || courses.length === 0) {
            container.innerHTML = `<div class="text-gray-400 text-center text-sm py-4">–ù–µ—Ç –∫—É—Ä—Å–æ–≤.</div>`;
            return;
        }

        courses.forEach(course => {
            // –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: Go –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON –ø–æ–ª—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä (Title vs title)
            // –û–±—ã—á–Ω–æ JSON –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ lowercase: title, is_published
            const title = course.title || course.Title;
            const isPub = (course.is_published !== undefined) ? course.is_published : course.IsPublished;
            const authorName = course.author?.Name || course.Author?.Name || '–°–∏—Å—Ç–µ–º–∞';

            // –ü–æ–ª—É—á–∞–µ–º ID (Go GORM: ID, JSON: id –∏–ª–∏ ID)
            const cId = course.id || course.ID;

            const statusColor = isPub ? 'bg-indigo-500' : 'bg-gray-300';
            const statusText = isPub ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω' : '–ß–µ—Ä–Ω–æ–≤–∏–∫';

            const item = document.createElement('div');
            item.id = `course-item-${cId}`;
            item.className = "course-item group flex items-center justify-between p-2 rounded-md hover:bg-indigo-50 cursor-pointer border border-transparent hover:border-indigo-100 transition animate-fade-in mb-1";
            item.setAttribute('onclick', `selectCourse(${cId})`);

            item.innerHTML = `
                <div class="flex items-center truncate flex-grow">
                    <div class="w-1.5 h-10 ${statusColor} rounded-l mr-3"></div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-bold text-gray-800 truncate">${title} ${cId}</p>
                        <div class="flex items-center text-xs text-gray-500 mt-0.5 gap-2">
                            <span><i class="fas fa-user-circle"></i> ${authorName}</span>
                            <span class="text-gray-300">|</span>
                            <span>${statusText}</span>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity ml-2">
                    <button onclick="openEditCourseModal(event, ${cId})" class="w-7 h-7 rounded-full hover:bg-white text-gray-400 hover:text-blue-600 flex items-center justify-center"><i class="fas fa-pen text-xs"></i></button>
                    <button onclick="deleteCourse(event, ${cId})" class="w-7 h-7 rounded-full hover:bg-white text-gray-400 hover:text-red-600 flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                </div>
            `;
            container.appendChild(item);
        });

        if (currentCourseId) {
            const active = document.getElementById(`course-item-${currentCourseId}`);
            if(active) active.classList.add('bg-indigo-100', 'border-indigo-200');
        }
    }

    // --- –í–´–ë–û–† –ö–£–†–°–ê ---
    async function selectCourse(id) {
        if (currentCourseId === id) return;
        currentCourseId = id;

        // UI: –ü–æ–¥—Å–≤–µ—Ç–∫–∞
        document.querySelectorAll('[id^="course-item-"]').forEach(el => el.classList.remove('bg-indigo-100'));
        document.getElementById(`course-item-${id}`)?.classList.add('bg-indigo-100');

        // UI: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–æ–¥—É–ª—è
        const addModBtn = document.getElementById('add-module-btn');
        addModBtn.disabled = false;
        addModBtn.className = "text-indigo-600 hover:text-indigo-800 bg-indigo-50 p-1.5 rounded hover:bg-indigo-100 transition cursor-pointer";
        addModBtn.onclick = () => createModule(); // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–æ–∑–¥–∞–Ω–∏—è

        // UI: –°–±—Ä–æ—Å —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        document.getElementById('lesson-title-input').value = "";
        document.getElementById('lesson-title-input').disabled = true;
        document.getElementById('content-blocks-area').innerHTML = `<div class="text-center text-gray-400 mt-20">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫ —Å–ø—Ä–∞–≤–∞</div>`;

        // DATA: –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        const structContainer = document.getElementById('structure-container');
        structContainer.innerHTML = '<div class="text-center text-gray-400 mt-5"><i class="fas fa-spinner fa-spin"></i></div>';

        try {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫—É—Ä—Å —Ü–µ–ª–∏–∫–æ–º, —Ç–∞–∫ –∫–∞–∫ getCourseByID –¥–µ–ª–∞–µ—Ç Preload("Modules.Lessons")
            const course = await apiCall(`/api/courses/${id}`);
            renderModules(course.modules || []);
        } catch (e) {
            console.error(e);
            structContainer.innerHTML = '<div class="text-red-500 text-center text-xs">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        }
    }

    // --- MODULES & LESSONS RENDER ---
    function renderModules(modules) {
        const container = document.getElementById('structure-container');
        container.innerHTML = '';

        if (!modules || modules.length === 0) {
            container.innerHTML = `<div class="text-center text-sm text-gray-400 mt-4">–ú–æ–¥—É–ª–µ–π –Ω–µ—Ç.<br>–ù–∞–∂–º–∏—Ç–µ "+" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è.</div>`;
            return;
        }

        modules.forEach(mod => {
            const modId = mod.id || mod.ID;
            const modTitle = mod.title || mod.Title;
            const lessons = mod.lessons || [];

            const modDiv = document.createElement('div');
            modDiv.className = "mb-4 bg-white border rounded-lg overflow-hidden animate-fade-in";

            // –†–µ–Ω–¥–µ—Ä —É—Ä–æ–∫–æ–≤
            let lessonsHtml = '';
            if (lessons.length > 0) {
                lessonsHtml = `<ul class="text-sm">` + lessons.map(l => {
                    const lId = l.id || l.ID;
                    const lTitle = l.title || l.Title;
                    return `
                    <li onclick="loadLesson(${lId}, '${lTitle}')" class="p-2 pl-4 border-l-4 border-transparent hover:border-indigo-400 hover:bg-gray-50 flex justify-between items-center cursor-pointer group transition">
                        <span class="text-gray-600 group-hover:text-gray-900 truncate">${lTitle}</span>
                        <div class="hidden group-hover:flex space-x-2">
                             <i onclick="event.stopPropagation(); deleteLesson(${lId})" class="fas fa-trash text-xs text-gray-300 hover:text-red-500" title="–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–∫"></i>
                        </div>
                    </li>`;
                }).join('') + `</ul>`;
            } else {
                lessonsHtml = `<div class="p-2 text-xs text-gray-400 italic pl-4">–ù–µ—Ç —É—Ä–æ–∫–æ–≤</div>`;
            }

            // –†–µ–Ω–¥–µ—Ä —à–∞–ø–∫–∏ –º–æ–¥—É–ª—è
            modDiv.innerHTML = `
                <div class="bg-gray-100 p-2 flex justify-between items-center border-b group">
                    <h3 class="font-medium text-sm text-gray-800 pl-1 truncate w-full cursor-pointer"
                        onclick="editModule(${modId}, '${modTitle}')" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">${modTitle}</h3>
                    <div class="flex space-x-1 opacity-60 group-hover:opacity-100 transition">
                        <button onclick="createLesson(${modId})" class="text-green-600 hover:bg-green-100 p-1 rounded" title="–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫"><i class="fas fa-plus-square"></i></button>
                        <button onclick="deleteModule(${modId})" class="text-red-600 hover:bg-red-100 p-1 rounded" title="–£–¥–∞–ª–∏—Ç—å –º–æ–¥—É–ª—å"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                ${lessonsHtml}
            `;
            container.appendChild(modDiv);
        });
    }
    async function createModule() {
        if (!currentCourseId) return;
        const title = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è:");
        if (!title) return;

        try {
            await apiCall('/api/modules', 'POST', { course_id: currentCourseId, title: title });
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Ä—Å–∞ (–ª–µ–Ω–∏–≤–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞)
            selectCourse(currentCourseId);
            // –•–∏—Ç—Ä–æ—Å—Ç—å: —á—Ç–æ–±—ã selectCourse —Å—Ä–∞–±–æ—Ç–∞–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–ª—è —Ç–æ–≥–æ –∂–µ ID, —Å–±—Ä–æ—Å–∏–º —Ç–µ–∫—É—â–∏–π

            // –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –ø—Ä–æ—Å—Ç–æ –≤—ã–∑–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            refreshStructure();
        } catch (e) { alert(e.message); }
    }

    async function editModule(id, oldTitle) {
        const newTitle = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è:", oldTitle);
        if (!newTitle || newTitle === oldTitle) return;

        try {
            await apiCall(`/api/modules/${id}`, 'PUT', { title: newTitle });
            refreshStructure();
        } catch (e) { alert(e.message); }
    }

    async function deleteModule(id) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –º–æ–¥—É–ª—å –∏ –í–°–ï –µ–≥–æ —É—Ä–æ–∫–∏?")) return;
        try {
            await apiCall(`/api/modules/${id}`, 'DELETE');
            refreshStructure();
        } catch (e) { alert(e.message); }
    }



    async function createLesson(moduleId) {
        const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞:");
        if (!title) return;

        try {
            await apiCall('/api/lessons', 'POST', { module_id: moduleId, title: title });
            refreshStructure();
        } catch (e) { alert(e.message); }
    }

    async function deleteLesson(id) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–∫?")) return;
        try {
            await apiCall(`/api/lessons/${id}`, 'DELETE');
            refreshStructure();
        } catch (e) { alert(e.message); }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    async function refreshStructure() {
        if(!currentCourseId) return;
        // –¢—Ä—é–∫: —Å–±—Ä–∞—Å—ã–≤–∞–µ–º currentCourseId –Ω–∞ null –≤—Ä–µ–º–µ–Ω–Ω–æ, —á—Ç–æ–±—ã selectCourse —Å—Ä–∞–±–æ—Ç–∞–ª
        const tempId = currentCourseId;
        currentCourseId = null;
        await selectCourse(tempId);
    }

    // --- EDITOR LOGIC (LOAD LESSON) ---
    // --- –ó–ê–ì–†–£–ó–ö–ê –£–†–û–ö–ê (READ) ---
    async function loadLesson(lessonId, title) {
        // 1. UI RESET
        const area = document.getElementById('content-blocks-area');
        const titleInput = document.getElementById('lesson-title-input');
        const saveBtn = document.getElementById('save-content-btn');
        const addBtn = document.getElementById('add-block-btn');

        area.innerHTML = '<div class="flex flex-col items-center justify-center h-64 text-gray-400 animate-pulse"><i class="fas fa-layer-group text-4xl mb-4"></i><p>–ó–∞–≥—Ä—É–∑–∫–∞ –±–ª–æ–∫–æ–≤...</p></div>';

        titleInput.value = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        titleInput.disabled = true;
        saveBtn.disabled = true;
        addBtn.disabled = true;

        try {
            // 2. –ó–ê–ü–†–û–° –ö API
            const lesson = await apiCall(`/api/lessons/${lessonId}`, 'GET');

            // 3. –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –î–ê–ù–ù–´–•
            titleInput.value = lesson.title;
            titleInput.disabled = false;

            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å ID —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–∫–∞
            saveBtn.onclick = () => saveLessonContent(lessonId);

            area.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ –ª–æ–∞–¥–µ—Ä–∞

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Å—Å–∏–≤ content_blocks (–ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ Go Preload)
            const blocks = lesson.content_blocks || [];

            if (blocks.length > 0) {
                blocks.forEach(block => {
                    // block.data - —ç—Ç–æ JSON –æ–±—ä–µ–∫—Ç –∏–∑ –±–∞–∑—ã ({content: "...", extra: "..."})
                    addBlock(block.type, block.data);
                });
            } else {
                area.innerHTML = `<div class="text-center py-10 text-gray-300 border-2 border-dashed border-gray-200 rounded-lg">–£—Ä–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç.</div>`;
            }

            // 4. –ê–ö–¢–ò–í–ê–¶–ò–Ø –ö–ù–û–ü–û–ö
            saveBtn.disabled = false;
            saveBtn.className = "px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded shadow transition flex items-center gap-2";

            addBtn.disabled = false;
            addBtn.className = "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition cursor-pointer";

        } catch (e) {
            console.error(e);
            area.innerHTML = `<div class="text-red-500 p-4 bg-red-50 rounded border border-red-100">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</div>`;
        }
    }

    // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –£–†–û–ö–ê (UPDATE) ---
    // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –£–†–û–ö–ê (TITLE + CONTENT) ---
    async function saveLessonContent(id) {
        // 1. –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã UI
        const titleInput = document.getElementById('lesson-title-input');
        const container = document.getElementById('content-blocks-area');
        const saveBtn = document.getElementById('save-content-btn');

        // 2. –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å)
        const originalBtnHtml = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        saveBtn.disabled = true;

        // –î–ª—è –∫—Ä–∞—Å–æ—Ç—ã –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å opacity –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –ø–æ–∫–∞ –∏–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        container.classList.add('opacity-70', 'pointer-events-none');

        try {
            // 3. –°–ë–û–† –î–ê–ù–ù–´–• (SCRAPING)
            const blocks = [];

            // querySelectorAll –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Ö —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤ DOM.
            // –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –±–ª–æ–∫–æ–≤.
            const blockElements = container.querySelectorAll('.content-block');

            blockElements.forEach(el => {
                const type = el.dataset.type; // 'text', 'code', 'video', 'quiz'
                let blockData = {};

                // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –ü–†–û–°–¢–´–• –ë–õ–û–ö–û–í ---
                if (type === 'text' || type === 'code' || type === 'video') {
                    const contentEl = el.querySelector('.block-content');
                    if (contentEl) {
                        blockData.content = contentEl.value; // –¢–µ–∫—Å—Ç, –ö–æ–¥ –∏–ª–∏ URL
                    }
                }
                // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –¢–ï–°–¢–ê (QUIZ) ---
                else if (type === 'quiz') {
                    const questionEl = el.querySelector('.quiz-question');
                    blockData.question = questionEl ? questionEl.value : '';

                    blockData.options = [];
                    blockData.correct_index = 0; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 0, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ

                    // –°–æ–±–∏—Ä–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
                    const optionRows = el.querySelectorAll('.option-row');

                    optionRows.forEach((row, idx) => {
                        const textInput = row.querySelector('.quiz-option-text');
                        const radioInput = row.querySelector('.quiz-correct-radio');

                        if (textInput) {
                            blockData.options.push(textInput.value);

                            // –ï—Å–ª–∏ —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∞ –≤—ã–±—Ä–∞–Ω–∞, –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —ç—Ç–æ—Ç –∏–Ω–¥–µ–∫—Å
                            if (radioInput && radioInput.checked) {
                                blockData.correct_index = idx;
                            }
                        }
                    });
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –±–ª–æ–∫–∞ –≤ –º–∞—Å—Å–∏–≤
                // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç Go –º–æ–¥–µ–ª–∏: { Type: string, Data: JSONB }
                blocks.push({
                    type: type,
                    data: blockData
                });
            });

            // 4. –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–û–í
            // –®–∞–≥ –ê: –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–∫–∞ (–æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint –∏–ª–∏ –ø–æ–ª–µ)
            await apiCall(`/api/lessons/${id}`, 'PUT', { title: titleInput.value });

            // –®–∞–≥ –ë: –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (blocks –º–∞—Å—Å–∏–≤)
            await apiCall(`/api/lessons/${id}/content`, 'PUT', blocks);

            // 5. –£–°–ü–ï–®–ù–û–ï –ó–ê–í–ï–†–®–ï–ù–ò–ï
            saveBtn.innerHTML = '<i class="fas fa-check"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
            saveBtn.className = "px-4 py-2 bg-green-600 text-white text-sm font-medium rounded shadow transition flex items-center gap-2";

            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞ –≤ –ª–µ–≤–æ–º —Å–∞–π–¥–±–∞—Ä–µ (—á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–∞–∑—É)
            updateSidebarTitle(id, titleInput.value);

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫
            setTimeout(() => {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                saveBtn.className = "px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded shadow transition flex items-center gap-2";
                saveBtn.disabled = false;
            }, 1500);

        } catch (e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message);
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
            saveBtn.innerHTML = originalBtnHtml;
            saveBtn.disabled = false;
        } finally {
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            container.classList.remove('opacity-70', 'pointer-events-none');
        }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞
    function updateSidebarTitle(id, newTitle) {
        // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –≤ onclick –µ—Å—Ç—å –Ω–∞—à ID
        // –°–µ–ª–µ–∫—Ç–æ—Ä –∏—â–µ—Ç —Ç–µ–≥ <li>, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∞—Ç—Ä–∏–±—É—Ç onclick —Å —Ç–µ–∫—Å—Ç–æ–º "loadLesson(ID,"
        const listItem = document.querySelector(`li[onclick*="loadLesson(${id},"]`);
        if (listItem) {
            // –í–Ω—É—Ç—Ä–∏ li –∏—â–µ–º span —Å —Ç–µ–∫—Å—Ç–æ–º
            const textSpan = listItem.querySelector('span');
            if (textSpan) textSpan.textContent = newTitle;

            // –¢–∞–∫–∂–µ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å–∞–º –∞—Ç—Ä–∏–±—É—Ç onclick, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∫–ª–∏–∫–µ –ø–µ—Ä–µ–¥–∞–ª—Å—è –Ω–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
            // –ò–Ω–∞—á–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–±—Ä–æ—Å–∏—Ç—Å—è –Ω–∞ —Å—Ç–∞—Ä—ã–π
            listItem.setAttribute('onclick', `loadLesson(${id}, '${newTitle.replace(/'/g, "\\'")}')`);
        }
    }


    // --- –í–´–ë–û–† –£–†–û–ö–ê ---


    // --- –ú–û–î–ê–õ–ö–ò (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏) ---
    function openCourseModal() {
        document.getElementById('course-form').reset();
        document.getElementById('course-id').value = '';
        document.getElementById('modal-course-title').textContent = '–°–æ–∑–¥–∞—Ç—å –ù–æ–≤—ã–π –ö—É—Ä—Å';
        document.getElementById('course-modal').classList.remove('hidden');
    }
    function openEditCourseModal(event, id) {
        event.stopPropagation();
        const course = globalCourses.find(c => c.id === id);
        if (!course) return;
        document.getElementById('course-id').value = course.id;
        document.getElementById('input-course-title').value = course.title;
        document.getElementById('input-course-published').checked = course.is_published;
        document.getElementById('modal-course-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—Å';
        document.getElementById('course-modal').classList.remove('hidden');
    }
    function closeCourseModal() { document.getElementById('course-modal').classList.add('hidden'); }
    async function handleCourseSubmit(event) {
        // 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã (—á—Ç–æ–±—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–ª–∞—Å—å)
        event.preventDefault();

        // 2. –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –ø–æ –∏—Ö ID
        const courseId = document.getElementById('course-id').value;
        const title = document.getElementById('input-course-title').value;
        // const description = document.getElementById('input-course-desc').value; // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ
        const isPublished = document.getElementById('input-course-published').checked;

        // 3. –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö (Payload)
        const payload = {
            title: title,
            // description: description,
            is_published: isPublished
        };

        try {
            let url = '/api/courses';
            let method = 'POST';

            // –ï—Å–ª–∏ ID —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∑–Ω–∞—á–∏—Ç –º—ã –†–ï–î–ê–ö–¢–ò–†–£–ï–ú, –∞ –Ω–µ —Å–æ–∑–¥–∞–µ–º
            if (courseId) {
                url = `/api/courses/${courseId}`;
                method = 'PUT';
            }

            // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä (Go)
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ CSRF –∑–∞—â–∏—Ç—É, –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω —Å—é–¥–∞:
                    // 'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞');
            }

            const result = await response.json();
            console.log('–£—Å–ø–µ—Ö:', result);

            // 5. –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            closeCourseModal();

            // –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫—É—Ä—Å–æ–≤, –≤—ã–∑–æ–≤–∏—Ç–µ –µ—ë –∑–¥–µ—Å—å
            if (typeof fetchCourses === 'function') {
                fetchCourses();
            } else {
                window.location.reload(); // –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—É—Ä—Å');
        }
    }
    async function deleteCourse(event, id) {
        event.stopPropagation();

        // 1. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (!confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫—É—Ä—Å —Å ID: ${id}?`)) {
            return;
        }

        try {
            // 2. –û—Ç–ø—Ä–∞–≤–∫–∞ DELETE-–∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –≤–∞—à Go-—Å–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç –Ω–∞ /api/courses/{id}
            const response = await fetch(`/api/courses/${id}`, {
                method: 'DELETE',
                // –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
                // headers: { 'Authorization': 'Bearer <–≤–∞—à_—Ç–æ–∫–µ–Ω>' }
            });

            // 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
            if (response.ok) {
                alert('‚úÖ –ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É –∏–∑ DOM)
                window.location.reload();
            } else {
                // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É (4xx –∏–ª–∏ 5xx)
                const errorText = await response.text();
                alert(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${response.status} - ${errorText || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            }

        } catch (error) {
            // –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ JavaScript
            console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
            alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.');
        }
    }

    // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –ë–õ–û–ö–û–í ---
    const typeModal = document.getElementById('type-modal');
    function openTypeModal() { typeModal.classList.remove('hidden'); }
    function closeTypeModal() { typeModal.classList.add('hidden'); }
    typeModal.addEventListener('click', (e) => { if (e.target === typeModal) closeTypeModal(); });

    // type: 'text' | 'code' | 'quiz' | 'image' | 'video'
    // data: –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ) –∏–ª–∏ null
    function addBlock(type, data = null) {
        const container = document.getElementById('content-blocks-area');

        // –£–¥–∞–ª—è–µ–º –∑–∞–≥–ª—É—à–∫—É "–£—Ä–æ–∫ –ø—É—Å—Ç", –µ—Å–ª–∏ –µ—Å—Ç—å
        const hasBlocks = container.querySelector('.content-block');
        if (!hasBlocks) container.innerHTML = '';

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–æ–∫
        const uniqueId = Date.now() + Math.random().toString(36).substr(2, 9);

        let innerHTML = '';
        let icon = '';
        let label = '';

        // –î–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const valContent = data ? data.content || '' : ''; // –î–ª—è text/code

        if (type === 'text') {
            icon = 'fa-align-left'; label = '–¢–µ–∫—Å—Ç';
            innerHTML = `<textarea class="block-content w-full border border-gray-300 p-3 rounded text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none transition resize-y" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç...">${valContent}</textarea>`;
        } else if (type === 'code') {
            icon = 'fa-code'; label = '–ö–æ–¥';
            innerHTML = `<textarea class="block-content w-full bg-[#1e1e1e] text-[#d4d4d4] p-3 rounded text-sm font-mono focus:ring-2 focus:ring-indigo-500 focus:outline-none transition" rows="4" placeholder="// Code...">${valContent}</textarea>`;
        } else if (type === 'video') {
            icon = 'fa-video'; label = 'YouTube';
            innerHTML = `<div class="flex items-center gap-2 border border-gray-300 p-2 rounded bg-white"><i class="fab fa-youtube text-red-500 text-lg"></i><input type="text" class="block-content w-full text-sm focus:outline-none" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ" value="${valContent}"></div>`;

        } else if (type === 'quiz') {
            // === –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø –¢–ï–°–¢–ê ===
            icon = 'fa-list-check'; label = '–¢–µ—Å—Ç (—Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏)';

            const question = data ? data.question || '' : '';
            const options = data ? data.options || [] : ['', '']; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 2 –ø—É—Å—Ç—ã—Ö
            const correctIndex = data ? data.correct_index : 0;

            innerHTML = `
                <div class="quiz-container">
                    <input type="text" class="quiz-question w-full border-b-2 border-indigo-100 p-2 text-sm font-bold mb-3 focus:border-indigo-500 focus:outline-none" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å..." value="${question}">

                    <div class="quiz-options pl-2 border-l-2 border-gray-100 space-y-2">
                        </div>

                    <button type="button" onclick="addQuizOption(this)" class="mt-2 text-xs text-indigo-600 hover:text-indigo-800 font-medium flex items-center gap-1">
                        <i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç
                    </button>
                </div>
            `;
        }

        const div = document.createElement('div');
        div.className = "content-block relative group bg-white border border-gray-200 rounded-lg p-1 mb-4 shadow-sm hover:shadow-md transition-all duration-200";
        div.dataset.type = type;
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –¥–ª—è —Ä–∞–¥–∏–æ-–≥—Ä—É–ø–ø—ã
        div.dataset.blockId = uniqueId;

        const toolbar = `
            <div class="flex justify-between items-center bg-gray-50 p-2 rounded-t-lg border-b border-gray-100 mb-2 handle cursor-move select-none">
                <div class="flex items-center gap-2 text-gray-500 text-xs font-bold uppercase tracking-wider"><i class="fas ${icon}"></i> ${label}</div>
                <div class="flex items-center gap-1">
                    <button onclick="moveBlock(this, -1)" class="w-6 h-6 text-gray-400 hover:text-indigo-600"><i class="fas fa-arrow-up"></i></button>
                    <button onclick="moveBlock(this, 1)" class="w-6 h-6 text-gray-400 hover:text-indigo-600"><i class="fas fa-arrow-down"></i></button>
                    <div class="w-px h-4 bg-gray-300 mx-1"></div>
                    <button onclick="removeBlock(this)" class="w-6 h-6 text-gray-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;

        div.innerHTML = toolbar + `<div class="p-2">${innerHTML}</div>`;
        container.appendChild(div);

        // --- –ü–û–°–¢-–û–ë–†–ê–ë–û–¢–ö–ê –î–õ–Ø QUIZ ---
        // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ—Å—Ç, –Ω—É–∂–Ω–æ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
        if (type === 'quiz') {
            // –ò—â–µ–º –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å", —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å –µ—ë –≤ —Ñ—É–Ω–∫—Ü–∏—é
            const addBtn = div.querySelector('button[onclick="addQuizOption(this)"]');

            // –î–∞–Ω–Ω—ã–µ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            const options = data ? data.options || ['', ''] : ['', ''];
            const correctIndex = data ? data.correct_index : 0; // –ò–Ω–¥–µ–∫—Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (0, 1...)

            options.forEach((optText, index) => {
                const isCorrect = (index === parseInt(correctIndex));
                addQuizOption(addBtn, optText, isCorrect);
            });
        }

        if (!data) {
            div.scrollIntoView({ behavior: 'smooth', block: 'center' });
            if(typeof closeTypeModal === 'function') closeTypeModal();
        }
    }


    // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ (swap —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ DOM)
    function moveBlock(btn, direction) {
        const currentBlock = btn.closest('.content-block');
        const container = document.getElementById('content-blocks-area');

        if (direction === -1) { // –í–≤–µ—Ä—Ö
            const prevBlock = currentBlock.previousElementSibling;
            if (prevBlock) {
                // –í—Å—Ç–∞–≤–∫–∞ –ø–µ—Ä–µ–¥ –ø—Ä–µ–¥—ã–¥—É—â–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º –º–µ–Ω—è–µ—Ç –∏—Ö –º–µ—Å—Ç–∞–º–∏
                container.insertBefore(currentBlock, prevBlock);
            }
        } else if (direction === 1) { // –í–Ω–∏–∑
            const nextBlock = currentBlock.nextElementSibling;
            if (nextBlock) {
                // –í—Å—Ç–∞–≤–∫–∞ –ø–µ—Ä–µ–¥ —ç–ª–µ–º–µ–Ω—Ç–æ–º, –∏–¥—É—â–∏–º –ü–û–°–õ–ï —Å–ª–µ–¥—É—é—â–µ–≥–æ (—Ç.–µ. –ø–æ—Å–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ)
                container.insertBefore(nextBlock, currentBlock);
            }
        }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    function removeBlock(btn) {
        if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫?")) return;

        const block = btn.closest('.content-block');
        const container = document.getElementById('content-blocks-area');

        // –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
        block.style.opacity = '0';
        block.style.transform = 'scale(0.95)';

        setTimeout(() => {
            block.remove();

            // --- ‚¨áÔ∏è –õ–û–ì–ò–ö–ê –í–û–ó–í–†–ê–¢–ê –ó–ê–ì–õ–£–®–ö–ò ‚¨áÔ∏è ---
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –±–ª–æ–∫–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
            const remainingBlocks = container.querySelectorAll('.content-block');
            if (remainingBlocks.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-gray-300 border-2 border-dashed border-gray-200 rounded-lg">–£—Ä–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç.</div>`;
            }
            // ---------------------------------------

        }, 200);
    }

    // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞
    function addQuizOption(btn, value = '', isCorrect = false) {
        // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—É—â–µ–≥–æ –±–ª–æ–∫–∞
        const optionsContainer = btn.closest('.quiz-container').querySelector('.quiz-options');

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –¥–ª—è —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–æ–∫ –≤–Ω—É—Ç—Ä–∏ –≠–¢–û–ì–û –±–ª–æ–∫–∞
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º timestamp –±–ª–æ–∫–∞, —á—Ç–æ–±—ã —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∏ –Ω–µ –ø—É—Ç–∞–ª–∏—Å—å –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏
        const blockId = btn.closest('.content-block').dataset.blockId;

        const div = document.createElement('div');
        div.className = "flex items-center gap-2 mb-2 option-row";
        div.innerHTML = `
            <input type="radio" name="quiz_radio_${blockId}" class="quiz-correct-radio w-4 h-4 text-indigo-600 focus:ring-indigo-500 border-gray-300" ${isCorrect ? 'checked' : ''} title="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π">
            <input type="text" class="quiz-option-text flex-1 border border-gray-300 p-2 rounded text-sm focus:outline-none focus:border-indigo-500 transition" placeholder="–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞" value="${value}">
            <button type="button" onclick="this.closest('.option-row').remove()" class="text-gray-400 hover:text-red-500 p-1" title="–£–¥–∞–ª–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç"><i class="fas fa-times"></i></button>
        `;
        optionsContainer.appendChild(div);
    }
</script>
</body>
</html>
{{end}}