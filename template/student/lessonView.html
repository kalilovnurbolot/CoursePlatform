{{define "lessonView"}}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Lesson.Title}} | {{.Course.Title}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #fdfcf7; font-family: 'Inter', sans-serif; }
        .prose-book { max-width: 70ch; margin: auto; line-height: 1.8; color: #374151; font-size: 1.1rem; }
        .block-render { opacity: 0; transform: translateY(10px); animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    </style>
    <script>
        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            menu.classList.toggle('hidden');
        }
    </script>
</head>
<body class="pb-10">

{{template "headerPersonal" .}}

<main class="max-w-4xl mx-auto pt-6 px-4">

    <nav class="flex justify-between items-center mb-10 text-sm">
        <a href="/course/{{.Course.ID}}/learn" class="text-indigo-600 font-bold hover:underline flex items-center">
            <i class="fas fa-list-ul mr-2"></i> Содержание книги
        </a>
        <div class="text-gray-400 italic truncate max-w-[200px] sm:max-w-none">
            {{.Course.Title}}
        </div>
    </nav>

    <header class="text-center mb-12">
        <h1 class="text-3xl md:text-4xl font-serif font-bold text-gray-900 mb-4">{{.Lesson.Title}}</h1>
        <div class="h-1 w-16 bg-indigo-500 mx-auto rounded-full"></div>
    </header>

    <article class="prose-book space-y-10 mb-20">
        {{range .Lesson.ContentBlocks}}
        <div class="block-render" data-type="{{.Type}}" data-id="{{.ID}}" data-raw="{{.Data}}"></div>
        {{end}}
    </article>

    <footer class="border-t border-stone-200 pt-10">
        <div class="grid grid-cols-1 sm:grid-cols-3 items-center gap-8 text-center">

            <div class="sm:text-left order-2 sm:order-1">
                {{if .PrevLessonID}}
                <a href="/course/{{.Course.ID}}/lesson/{{.PrevLessonID}}" class="group inline-block">
                    <p class="text-[10px] text-gray-400 uppercase font-black tracking-widest mb-1">Назад</p>
                    <span class="text-indigo-600 font-medium italic group-hover:underline">← Предыдущая страница</span>
                </a>
                {{end}}
            </div>

            <div class="order-1 sm:order-2">
                <button id="mark-done-btn" onclick="completeLesson()"
                        class="w-full sm:w-auto px-10 py-4 rounded-2xl font-bold transition-all shadow-lg
                        {{if .IsLessonDone}}bg-emerald-100 text-emerald-700 cursor-default{{else}}bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95 shadow-indigo-200{{end}}">
                    {{if .IsLessonDone}}<i class="fas fa-check-double mr-2"></i> Прочитано{{else}}Завершить чтение{{end}}
                </button>
            </div>

            <div class="sm:text-right order-3">
                {{if .NextLessonID}}
                <a href="/course/{{.Course.ID}}/lesson/{{.NextLessonID}}" class="group inline-block">
                    <p class="text-[10px] text-gray-400 uppercase font-black tracking-widest mb-1">Далее</p>
                    <span class="text-indigo-600 font-medium italic group-hover:underline">Следующая глава →</span>
                </a>
                {{else}}
                <div class="text-emerald-600 font-bold italic text-sm">Конец книги <i class="fas fa-flag-checkered ml-1"></i></div>
                {{end}}
            </div>

        </div>
    </footer>
</main>

<script>
    let savedAttempts = [];
    try {
        const raw = {{if .AttemptsJSON}}{{.AttemptsJSON}}{{else}}"[]"{{end}};
        savedAttempts = typeof raw === 'string' ? JSON.parse(raw) : (raw || []);
        if (!Array.isArray(savedAttempts)) savedAttempts = [];
    } catch (e) { savedAttempts = []; }

    const courseLang = "{{.CourseLanguage}}";

    document.addEventListener('DOMContentLoaded', renderBlocks);

    function renderBlocks() {
        document.querySelectorAll('.block-render').forEach(el => {
            try {
                const type = el.dataset.type;
                const blockId = parseInt(el.dataset.id);
                const data = JSON.parse(el.dataset.raw);

                if (type === 'quiz') {
                    const previous = savedAttempts.find(a => a.block_id === blockId);
                    el.innerHTML = renderQuiz(data, blockId, previous);
                } else if (type === 'text') {
                    el.innerHTML = `<div class="text-gray-700 leading-relaxed">${data.content.replace(/\n/g, '<br>')}</div>`;
                } else if (type === 'code') {
                    el.innerHTML = `<pre class="bg-slate-900 text-indigo-100 p-5 rounded-2xl overflow-x-auto font-mono text-sm"><code>${escapeHtml(data.content)}</code></pre>`;
                } else if (type === 'video') {
                    const videoId = extractYoutubeId(data.content);
                    el.innerHTML = `<div class="aspect-video rounded-2xl overflow-hidden bg-black shadow-xl"><iframe class="w-full h-full" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe></div>`;
                } else if (type === 'vocabulary') {
                    el.innerHTML = renderVocabulary(data);
                } else if (type === 'audio_dictation') {
                    const previous = savedAttempts.find(a => a.block_id === blockId);
                    el.innerHTML = renderAudioDictation(data, blockId, previous);
                }
            } catch (err) { console.error("Block error:", err); }
        });
    }

    function renderVocabulary(data) {
        const title = data.title || 'Новые слова';
        const words = data.words || [];

        if (words.length === 0) return '';

        const rows = words.map(w => `
            <div class="flex flex-col sm:flex-row sm:items-center justify-between p-4 border-b border-gray-100 last:border-0 hover:bg-green-50/50 transition">
                <div class="flex items-baseline gap-3">
                    <span class="font-bold text-gray-800 text-lg">${w.term}</span>
                    <span class="font-mono text-sm text-gray-500">${w.transcription}</span>
                </div>
                <div class="text-gray-700 italic mt-1 sm:mt-0">${w.translation}</div>
            </div>
        `).join('');

        return `
            <div class="bg-white border-l-4 border-green-500 rounded-r-xl shadow-sm my-8 overflow-hidden">
                <div class="bg-green-50 px-6 py-3 border-b border-green-100">
                    <h4 class="font-bold text-green-800 flex items-center gap-2">
                        <i class="fas fa-book-open"></i> ${title}
                    </h4>
                </div>
                <div class="divide-y divide-gray-100">
                    ${rows}
                </div>
            </div>
        `;
    }

    function renderQuiz(data, blockId, previous = null) {
        const isAnswered = previous !== null;
        return `
            <div class="bg-white border-2 border-indigo-50 rounded-3xl p-6 md:p-8 shadow-sm my-10 relative overflow-hidden">
                ${isAnswered ? '<div class="absolute top-0 right-0 bg-indigo-50 text-indigo-500 text-[10px] font-bold px-3 py-1 rounded-bl-xl uppercase tracking-tighter">История ответов</div>' : ''}
                <h4 class="font-bold text-gray-800 text-lg mb-6 leading-tight">${data.question}</h4>
                <div class="grid gap-3" data-answered="${isAnswered}">
                    ${data.options.map((opt, i) => {
            let cls = "bg-gray-50 border-gray-50 text-gray-700";
            let icon = "";
            if (isAnswered) {
                if (i === data.correct_index) {
                    cls = "bg-emerald-50 border-emerald-500 text-emerald-700 font-bold";
                    icon = '<i class="fas fa-check-circle float-right"></i>';
                } else if (i === previous.selected_index && !previous.is_correct) {
                    cls = "bg-rose-50 border-rose-500 text-rose-700 font-bold";
                    icon = '<i class="fas fa-times-circle float-right"></i>';
                }
            }
            return `
                            <button onclick="checkAnswer(this, ${blockId}, ${i}, ${data.correct_index}, '${data.question.replace(/'/g, "\\'")}')"
                                    ${isAnswered ? 'disabled' : ''}
                                    class="quiz-option w-full text-left p-4 rounded-2xl border-2 transition-all font-medium ${cls} ${isAnswered ? '' : 'hover:border-indigo-200 hover:bg-indigo-50/50'}">
                                <span class="inline-block w-6 text-gray-300 font-mono text-xs">${String.fromCharCode(65 + i)}</span>
                                ${opt} ${icon}
                            </button>`;
        }).join('')}
                </div>
            </div>`;
    }

    function renderAudioDictation(data, blockId, previous = null) {
        const isAnswered = previous !== null;
        let resultHtml = '';
        if (isAnswered) {
            const isCorrect = previous.is_correct;
            resultHtml = `
                <div class="mt-4 p-4 rounded-lg text-sm ${isCorrect ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}">
                    <p><b>Ваш ответ:</b> ${escapeHtml(previous.answer)}</p>
                    ${!isCorrect ? `<p class="mt-2"><b>Правильный ответ:</b> ${escapeHtml(data.text)}</p>` : ''}
                </div>
            `;
        }

        return `
            <div class="bg-white border-l-4 border-purple-500 rounded-r-xl shadow-sm my-8 p-6">
                <h4 class="font-bold text-purple-800 mb-4">Аудио-диктант</h4>
                <p class="text-sm text-gray-600 mb-4">Прослушайте фразу и напишите то, что услышали.</p>
                <div class="flex items-center gap-4">
                    <button onclick="speakText('${data.text.replace(/'/g, "\\'")}')" class="w-16 h-16 rounded-full bg-purple-600 text-white flex items-center justify-center text-2xl hover:bg-purple-700 transition shadow-lg">
                        <i class="fas fa-play"></i>
                    </button>
                    <textarea id="audio-input-${blockId}" class="flex-1 border-2 border-gray-200 p-3 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" rows="2" placeholder="Напишите здесь..." ${isAnswered ? 'disabled' : ''}>${isAnswered ? previous.answer : ''}</textarea>
                </div>
                ${!isAnswered ? `
                <div class="text-right mt-4">
                    <button onclick="checkAudioAnswer(this, ${blockId}, '${data.text.replace(/'/g, "\\'")}')" class="px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition">Проверить</button>
                </div>
                ` : ''}
                <div id="audio-result-${blockId}">${resultHtml}</div>
            </div>
        `;
    }

    function speakText(text) {
        if (!('speechSynthesis' in window)) {
            alert("Ваш браузер не поддерживает синтез речи.");
            return;
        }
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = courseLang || 'en-US';
        window.speechSynthesis.speak(utterance);
    }

    function normalizeText(text) {
        return text.trim().toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
    }

    async function checkAudioAnswer(btn, blockId, correctAnswer) {
        const input = document.getElementById(`audio-input-${blockId}`);
        const userAnswer = input.value;
        const isCorrect = normalizeText(userAnswer) === normalizeText(correctAnswer);

        btn.disabled = true;
        input.disabled = true;

        const resultContainer = document.getElementById(`audio-result-${blockId}`);
        resultContainer.innerHTML = `
            <div class="mt-4 p-4 rounded-lg text-sm ${isCorrect ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}">
                <p><b>Ваш ответ:</b> ${escapeHtml(userAnswer)}</p>
                ${!isCorrect ? `<p class="mt-2"><b>Правильный ответ:</b> ${escapeHtml(correctAnswer)}</p>` : ''}
            </div>
        `;

        await fetch(`/api/course/{{.Course.ID}}/lesson/{{.Lesson.ID}}/quiz`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                block_id: blockId,
                question: "Аудио-диктант",
                answer: userAnswer,
                is_correct: isCorrect
            })
        });
    }

    async function checkAnswer(btn, blockId, idx, correctIdx, qText) {
        const parent = btn.parentElement;
        if (parent.dataset.answered === "true") return;
        parent.dataset.answered = "true";

        const isCorrect = (idx === correctIdx);
        const ansText = btn.innerText.replace(/^[A-Z]\s/, "").trim();

        parent.querySelectorAll('.quiz-option').forEach((opt, i) => {
            opt.disabled = true;
            if (i === correctIdx) {
                opt.classList.add('bg-emerald-50', 'border-emerald-500', 'text-emerald-700');
                opt.innerHTML += ' <i class="fas fa-check-circle float-right mt-1"></i>';
            } else if (i === idx && !isCorrect) {
                opt.classList.add('bg-rose-50', 'border-rose-500', 'text-rose-700');
                opt.innerHTML += ' <i class="fas fa-times-circle float-right mt-1"></i>';
            }
        });

        await fetch(`/api/course/{{.Course.ID}}/lesson/{{.Lesson.ID}}/quiz`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                block_id: blockId,
                selected_index: idx,
                question: qText,
                answer: ansText,
                is_correct: isCorrect
            })
        });
    }

    async function completeLesson() {
        const btn = document.getElementById('mark-done-btn');
        if (btn.classList.contains('bg-emerald-100')) return;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Сохранение...';

        const res = await fetch(`/api/course/{{.Course.ID}}/lesson/{{.Lesson.ID}}/done`, { method: 'POST' });
        if (res.ok) {
            btn.innerHTML = '<i class="fas fa-check-double mr-2"></i> Прочитано';
            btn.className = "w-full sm:w-auto px-10 py-4 rounded-2xl font-bold bg-emerald-500 text-white shadow-lg";
            setTimeout(() => window.location.reload(), 600);
        }
    }

    function extractYoutubeId(url) {
        const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    function escapeHtml(t) {
        const m = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return t.replace(/[&<>"']/g, s => m[s]);
    }
</script>

</body>
</html>
{{end}}